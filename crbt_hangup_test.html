<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive CRBT Test Case Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs for Firestore and Authentication -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - PROVIDED BY USER
        const firebaseConfig = {
            apiKey: "AIzaSyBTBFvZo4WEP0SpIiUsgAdH0GnyIuv3Fng",
            authDomain: "test-case-sheet.firebaseapp.com",
            projectId: "test-case-sheet",
            storageBucket: "test-case-sheet.firebasestorage.app",
            messagingSenderId: "618641553048",
            appId: "1:618641553048:web:0a62cd76c82387f43282ed",
            measurementId: "G-4MNL7X8TSW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let authReady = false;

        // Listen for authentication state changes (anonymous sign-in for all users)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authReady = true;
                console.log("Authenticated as:", currentUserId);
                // Dispatch event to signal that Firebase is ready
                window.dispatchEvent(new CustomEvent('firebaseReady'));
            } else {
                // Sign in anonymously if no user is found
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Firebase anonymous authentication error:", error);
                    // Display a message to the user if authentication fails
                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        if (error.code === 'auth/configuration-not-found' || error.code === 'auth/api-key-not-valid') {
                            loadingMessage.textContent = 'Firebase connection error: Anonymous authentication might not be enabled in your Firebase project, or your API key is invalid. Please check Firebase Console > Authentication > Sign-in method, and ensure your firebaseConfig details are correct.';
                        } else if (error.code === 'auth/network-request-failed') {
                             loadingMessage.textContent = 'Firebase connection error: Network issue. Please check your internet connection.';
                        }
                        else {
                            loadingMessage.textContent = `Failed to connect to shared data. Error: ${error.message}. Please check your network connection and browser console for more details.`;
                        }
                        loadingMessage.classList.add('text-red-600');
                    }
                }
            }
        });

        // Make Firebase instances and userId available globally for the main script
        window.firestoreDb = db;
        window.getUserId = () => currentUserId;
        window.isAuthReady = () => authReady;
        window.getAppId = () => firebaseConfig.projectId; // Using projectId as appId for Firestore path
    </script>

    <!-- Chosen Palette: Neutral Professional -->
    <!-- Application Structure Plan: The application is structured as an interactive dashboard. It features a main header, a filtering control panel with scenario-based categories, and a dynamic content area. Test cases are presented as responsive cards. Users can filter cases by 'Scenario Group' (New User, Active User, Edge Cases) using buttons. Crucially, users can now add new test cases via a modal form and delete existing ones directly from their cards. This structure is chosen to facilitate efficient management and exploration of CRBT test scenarios, providing immediate visual feedback on status and allowing dynamic modification of the test suite. -->
    <!-- Visualization & Content Choices: Test Case Scenarios -> Goal: Organize/Filter -> Presentation: Filter buttons based on 'Scenario Group' categories. Interaction: On click, JS filters and displays relevant test case cards. Justification: Intuitive navigation for specific scenario types. Individual Test Cases -> Goal: Inform/Track Status/Manage -> Presentation: Styled cards displaying ID, Description, Pre-conditions, Test Steps, and Expected Result. Includes Pass/Fail buttons for status tracking, a Delete button for removal, and an Edit button for modification. Interaction: Click Pass/Fail to toggle status (persisted via Firebase Firestore); click Delete to remove (persisted via Firebase Firestore); click Edit to open pre-populated modal for modification (persisted via Firebase Firestore). Add New Test Case -> Goal: Manage/Extend -> Presentation: Modal form with input fields for all test case properties. Interaction: Form submission adds a new test case to the data and re-renders the grid (persisted via Firebase Firestore). Justification: Provides a structured way to extend the test suite dynamically. Edit Test Case -> Goal: Manage/Modify -> Presentation: Modal form pre-populated with existing data. Interaction: Form submission updates the existing test case in data and re-renders (persisted via Firebase Firestore). Justification: Allows for correction and refinement of test cases. Data Counter -> Goal: Inform -> Presentation: Text label. Interaction: Updates counts of visible, passed, and failed cases upon filtering or modification. Justification: Offers immediate progress feedback. Generate Excel Report -> Goal: Export/Report -> Presentation: Button. Interaction: Downloads a CSV file with all current test cases and their statuses. Justification: Provides an offline, shareable record of the test suite. No charts are used as the data is primarily textual and categorical, not quantitative for charting. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7f4;
        }
        .filter-btn {
            transition: all 0.3s ease;
        }
        .filter-btn.active {
            background-color: #3b82f6;
            color: #ffffff;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39);
        }
        .test-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            will-change: transform;
            display: flex;
            flex-direction: column;
        }
        .card-content {
            flex-grow: 1;
        }
        .status-button {
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
        .status-button:active {
            transform: scale(0.98);
        }
        .status-pass.active {
            background-color: #22c55e; /* Green 500 */
            color: white;
        }
        .status-fail.active {
            background-color: #ef4444; /* Red 500 */
            color: white;
        }
        .status-pending {
            background-color: #f3f4f6; /* Gray 100 */
            color: #4b5563; /* Gray 600 */
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 600px; /* Wider modal for more fields */
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
            .form-grid .full-width {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto px-4 py-8 md:py-12">

        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">CRBT Service Test Case Explorer</h1>
            <p class="mt-2 text-lg text-gray-600">An interactive guide to the SMS Notification & Subscription Logic test suite.</p>
        </header>

        <div id="controls" class="mb-8 p-4 bg-white/60 backdrop-blur-sm rounded-xl shadow-sm border border-gray-200 sticky top-4 z-10">
            <div class="flex flex-wrap items-center justify-center gap-3">
                <span class="font-semibold text-gray-700 mr-3">Filter by Scenario:</span>
                <button data-filter="all" class="filter-btn active text-sm font-medium py-2 px-4 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">All Cases</button>
                <button data-filter="new-user" class="filter-btn text-sm font-medium py-2 px-4 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">New User</button>
                <button data-filter="active-user" class="filter-btn text-sm font-medium py-2 px-4 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">Active User</button>
                <button data-filter="edge-case" class="filter-btn text-sm font-medium py-2 px-4 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300">Edge Cases</button>
            </div>
            <p id="case-counter" class="text-center text-sm text-gray-500 mt-3"></p>
            <div class="flex justify-center mt-4 gap-4">
                <button id="generate-excel-btn" class="bg-purple-600 text-white font-medium py-2 px-5 rounded-full shadow-lg hover:bg-purple-700 transition-colors duration-200">
                    Generate Excel Report
                </button>
                <button id="add-test-case-btn" class="bg-blue-600 text-white font-medium py-2 px-5 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200">
                    Add New Test Case
                </button>
            </div>
        </div>
        
        <main id="test-case-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div id="loading-message" class="col-span-full text-center text-gray-500 text-lg mt-8">
                Loading test cases... Please ensure your Firebase API key is valid and rules are set for public read/write.
            </div>
        </main>

    </div>

    <!-- Add Test Case Modal -->
    <div id="add-test-case-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-900">Add New Test Case</h2>
            <form id="add-test-case-form" class="space-y-4">
                <div class="form-grid">
                    <div>
                        <label for="new-test-id" class="block text-sm font-medium text-gray-700">Test Case ID (e.g., CRBT-CUSTOM-001)</label>
                        <input type="text" id="new-test-id" name="id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label for="new-test-category" class="block text-sm font-medium text-gray-700">Scenario Category</label>
                        <select id="new-test-category" name="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            <option value="new-user">New User</option>
                            <option value="active-user">Active User</option>
                            <option value="edge-case">Edge Case</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label for="new-test-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="new-test-description" name="description" rows="2" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                    <div class="full-width">
                        <label for="new-test-preconditions" class="block text-sm font-medium text-gray-700">Pre-conditions (one per line)</label>
                        <textarea id="new-test-preconditions" name="preConditions" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                    <div class="full-width">
                        <label for="new-test-steps" class="block text-sm font-medium text-gray-700">Test Steps (one per line)</label>
                        <textarea id="new-test-steps" name="testSteps" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                    <div class="full-width">
                        <label for="new-test-expected-result" class="block text-sm font-medium text-gray-700">Expected Result</label>
                        <textarea id="new-test-expected-result" name="expectedResult" rows="2" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-add-test-case" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Add Test Case</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Test Case Modal -->
    <div id="edit-test-case-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-900">Edit Test Case</h2>
            <form id="edit-test-case-form" class="space-y-4">
                <input type="hidden" id="edit-original-id" name="originalId">
                <div class="form-grid">
                    <div>
                        <label for="edit-test-id" class="block text-sm font-medium text-gray-700">Test Case ID</label>
                        <input type="text" id="edit-test-id" name="id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label for="edit-test-category" class="block text-sm font-medium text-gray-700">Scenario Category</label>
                        <select id="edit-test-category" name="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            <option value="new-user">New User</option>
                            <option value="active-user">Active User</option>
                            <option value="edge-case">Edge Case</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label for="edit-test-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="edit-test-description" name="description" rows="2" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                    <div class="full-width">
                        <label for="edit-test-preconditions" class="block text-sm font-medium text-gray-700">Pre-conditions (one per line)</label>
                        <textarea id="edit-test-preconditions" name="preConditions" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                    <div class="full-width">
                        <label for="edit-test-steps" class="block text-sm font-medium text-gray-700">Test Steps (one per line)</label>
                        <textarea id="edit-test-steps" name="testSteps" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                    <div class="full-width">
                        <label for="edit-test-expected-result" class="block text-sm font-medium text-gray-700">Expected Result</label>
                        <textarea id="edit-test-expected-result" name="expectedResult" rows="2" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-edit-test-case" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initial test case data. This will be used if Firestore is empty.
        // Once Firestore data is loaded, this array will be overwritten.
        let testCases = [
            {
                id: 'CRBT-NEW-001',
                category: 'new-user',
                description: 'Verify Hangup & Promotional SMS for A-Party (New User) calling B-Party (CRBT Active) - First Call of the Day.',
                preConditions: [
                    'A-Party is a new user (never subscribed to CRBT).',
                    'B-Party has an active CRBT service.'
                ],
                testSteps: [
                    'A-Party initiates a call to B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive a "Hangup SMS" (e.g., "You heard this tune, press Y to subscribe") AND a "Promotional SMS" upon call disconnection.',
                status: 'pending'
            },
            {
                id: 'CRBT-NEW-002',
                category: 'new-user',
                description: 'Verify Hangup SMS ONLY for A-Party (New User) calling Different B-Party (CRBT Active) - Second Call of the Day.',
                preConditions: [
                    'A-Party is a new user who has already made *one* CRBT-active call today.',
                    'A-Party calls a *different* B-Party who has an active CRBT service.'
                ],
                testSteps: [
                    'A-Party initiates a call to a *different* B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive ONLY a "Hangup SMS" upon call disconnection. No Promotional SMS should be received.',
                status: 'pending'
            },
            {
                id: 'CRBT-NEW-003',
                category: 'new-user',
                description: 'Verify NO SMS for A-Party (New User) calling Different B-Party (CRBT Active) - Third Call of the Day.',
                preConditions: [
                    'A-Party is a new user who has already made *two* CRBT-active calls today.',
                    'A-Party calls a *different* B-Party who has an active CRBT service.'
                ],
                testSteps: [
                    'A-Party initiates a call to a *different* B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive NO SMS (neither Hangup nor Promotional) upon call disconnection.',
                status: 'pending'
            },
            {
                id: 'CRBT-ACTIVE-001',
                category: 'active-user',
                description: 'Verify Hangup & Promotional SMS for A-Party (Active CRBT User) calling B-Party (CRBT Active) - First Call of the Day.',
                preConditions: [
                    'A-Party is an active CRBT subscriber.',
                    'B-Party has an active CRBT service.'
                ],
                testSteps: [
                    'A-Party initiates a call to B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive a "Hangup SMS" AND a "Promotional SMS" upon call disconnection.',
                status: 'pending'
            },
            {
                id: 'CRBT-ACTIVE-002',
                category: 'active-user',
                description: 'Verify Hangup SMS ONLY for A-Party (Active CRBT User) calling Different B-Party (CRBT Active) - Second Call of the Day.',
                preConditions: [
                    'A-Party is an active CRBT subscriber who has already made *one* CRBT-active call today.',
                    'A-Party calls a *different* B-Party who has an active CRBT service.'
                ],
                testSteps: [
                    'A-Party initiates a call to a *different* B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive ONLY a "Hangup SMS" upon call disconnection. No Promotional SMS should be received.',
                status: 'pending'
            },
            {
                id: 'CRBT-ACTIVE-003',
                category: 'active-user',
                description: 'Verify NO SMS for A-Party (Active CRBT User) calling Different B-Party (CRBT Active) - Third Call of the Day.',
                preConditions: [
                    'A-Party is an active CRBT subscriber who has already made *two* CRBT-active calls today.',
                    'A-Party calls a *different* B-Party who has an active CRBT service.'
                ],
                testSteps: [
                    'A-Party initiates a call to a *different* B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive NO SMS (neither Hangup nor Promotional) upon call disconnection.',
                status: 'pending'
            },
            {
                id: 'CRBT-ACTIVE-004',
                category: 'active-user',
                description: 'Verify NO SMS for A-Party (Active CRBT User) calling B-Party (CRBT Active - Same Song).',
                preConditions: [
                    'A-Party is an active CRBT subscriber.',
                    'B-Party has an active CRBT service.',
                    'The CRBT tune of B-Party is *identical* to the song A-Party is currently subscribed to.'
                ],
                testSteps: [
                    'A-Party initiates a call to B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive NO SMS (neither Hangup nor Promotional) upon call disconnection.',
                status: 'pending'
            },
            {
                id: 'CRBT-EDGE-001',
                category: 'edge-case',
                description: 'Verify No SMS when B-Party does NOT have CRBT service.',
                preConditions: [
                    'A-Party is a new or active CRBT user.',
                    'B-Party does NOT have an active CRBT service.'
                ],
                testSteps: [
                    'A-Party initiates a call to B-Party.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive NO SMS (neither Hangup nor Promotional) upon call disconnection, as CRBT was not active for B-Party.',
                status: 'pending'
            },
            {
                id: 'CRBT-EDGE-002',
                category: 'edge-case',
                description: 'Verify Daily SMS Counter Resets at Midnight.',
                preConditions: [
                    'A-Party is a new user who made 3 CRBT-active calls on Day 1 (and received no SMS on the 3rd call).',
                    'B-Party has an active CRBT service.'
                ],
                testSteps: [
                    'Advance system time to Day 2 (new day).',
                    'A-Party initiates a call to B-Party.',
                    'A-Party listens to the B-Party\'s CRBT.',
                    'B-Party answers the call (or call completes).'
                ],
                expectedResult: 'A-Party should receive a "Hangup SMS" AND a "Promotional SMS" upon call disconnection, as the daily counter for SMS notifications should have reset.',
                status: 'pending'
            },
            {
                id: 'CRBT-EDGE-003',
                category: 'edge-case',
                description: 'Verify behavior when call is disconnected before CRBT plays or B-Party answers.',
                preConditions: [
                    'A-Party initiates a call to B-Party.',
                    'A-Party disconnects the call *before* the CRBT plays fully or before B-Party answers.'
                ],
                expectedResult: 'A-Party should receive NO SMS (neither Hangup nor Promotional) as the CRBT interaction was not completed as per conditions.',
                status: 'pending'
            }
        ];

        const grid = document.getElementById('test-case-grid');
        const counter = document.getElementById('case-counter');
        const loadingMessage = document.getElementById('loading-message');
        let currentFilter = 'all';

        function updateCaseCounter() {
            const visibleCards = Array.from(grid.children).filter(card => !card.classList.contains('hidden'));
            const passedCount = visibleCards.filter(card => card.dataset.status === 'pass').length;
            const failedCount = visibleCards.filter(card => card.dataset.status === 'fail').length;
            const totalVisible = visibleCards.length;

            counter.textContent = `Showing ${totalVisible} of ${testCases.length} total test cases. (Passed: ${passedCount}, Failed: ${failedCount})`;
        }

        async function saveTestCaseToFirestore(testCaseData) {
            if (!window.isAuthReady()) {
                console.error("Firestore not ready: Authentication not complete.");
                return;
            }
            const appId = window.getAppId();
            // Using 'crbt_test_cases' collection for CRBT data
            const docRef = doc(window.firestoreDb, `artifacts/${appId}/public/data/crbt_test_cases`, testCaseData.id);
            try {
                await setDoc(docRef, testCaseData, { merge: true });
                console.log(`Test case ${testCaseData.id} saved/updated in Firestore.`);
            } catch (e) {
                console.error("Error saving/updating document: ", e);
                alert("Error saving test case. Check console for details.");
            }
        }

        async function deleteTestCaseFromFirestore(testCaseId) {
            if (!window.isAuthReady()) {
                console.error("Firestore not ready: Authentication not complete.");
                return;
            }
            const appId = window.getAppId();
            // Using 'crbt_test_cases' collection for CRBT data
            const docRef = doc(window.firestoreDb, `artifacts/${appId}/public/data/crbt_test_cases`, testCaseId);
            try {
                await deleteDoc(docRef);
                console.log(`Test case ${testCaseId} deleted from Firestore.`);
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("Error deleting test case. Check console for details.");
            }
        }

        function updateCardDisplayStatus(cardElement, newStatus) {
            const testCaseId = cardElement.dataset.id;
            const testCaseIndex = testCases.findIndex(tc => tc.id === testCaseId);
            if (testCaseIndex !== -1) {
                testCases[testCaseIndex].status = newStatus; // Update the in-memory array
            }

            cardElement.dataset.status = newStatus;
            const statusIndicator = cardElement.querySelector('.status-indicator');
            const passButton = cardElement.querySelector('.status-pass');
            const failButton = cardElement.querySelector('.status-fail');

            statusIndicator.className = 'status-indicator inline-block text-xs font-semibold px-2.5 py-0.5 rounded-full capitalize';
            passButton.className = 'status-button status-pass text-sm font-medium py-1.5 px-3 rounded-full border border-green-500 text-green-700 hover:bg-green-100';
            failButton.className = 'status-button status-fail text-sm font-medium py-1.5 px-3 rounded-full border border-red-500 text-red-700 hover:bg-red-100';

            if (newStatus === 'pass') {
                statusIndicator.classList.add('bg-green-100', 'text-green-800');
                statusIndicator.textContent = 'Passed';
                passButton.classList.add('active');
            } else if (newStatus === 'fail') {
                statusIndicator.classList.add('bg-red-100', 'text-red-800');
                statusIndicator.textContent = 'Failed';
                failButton.classList.add('active');
            } else { // 'pending'
                statusIndicator.classList.add('bg-gray-100', 'text-gray-600');
                statusIndicator.textContent = 'Pending';
                passButton.classList.remove('active');
                failButton.classList.remove('active');
            }
            updateCaseCounter();
        }

        function createTestCaseCard(tc) {
            const card = document.createElement('div');
            card.className = `test-card bg-white rounded-lg shadow-md border border-gray-200/80 p-6 relative`;
            card.dataset.category = tc.category;
            card.dataset.id = tc.id;
            card.dataset.status = tc.status;

            const preConditionsHtml = Array.isArray(tc.preConditions) ? tc.preConditions.map(item => `<li>${item}</li>`).join('') : `<li>${tc.preConditions || 'N/A'}</li>`;
            const testStepsHtml = Array.isArray(tc.testSteps) ? tc.testSteps.map(item => `<li>${item}</li>`).join('') : `<li>${tc.testSteps || 'N/A'}</li>`;

            card.innerHTML = `
                <div class="card-header mb-4 flex justify-between items-center">
                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${tc.id}</span>
                    <div class="flex gap-2">
                        <button class="edit-test-case-btn text-gray-500 hover:text-gray-700 text-sm font-medium px-2 py-1 rounded-full" data-id="${tc.id}">
                            &#x270E; Edit
                        </button>
                        <button class="delete-test-case-btn text-red-500 hover:text-red-700 text-sm font-medium px-2 py-1 rounded-full" data-id="${tc.id}">
                            &#x2715; Delete
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <p class="font-semibold text-gray-800 mb-4">${tc.description}</p>
                    
                    <div class="mb-4">
                        <h3 class="font-semibold text-sm text-gray-500 mb-2">📋 Pre-conditions</h3>
                        <ul class="list-disc list-inside text-gray-600 text-sm space-y-1">${preConditionsHtml}</ul>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-semibold text-sm text-gray-500 mb-2">▶️ Test Steps</h3>
                        <ol class="list-decimal list-inside text-gray-600 text-sm space-y-1">${testStepsHtml}</ol>
                    </div>
                    <p class="text-gray-600 text-sm"><strong>Expected Result:</strong> ${tc.expectedResult}</p>
                </div>
                <div class="card-footer mt-auto pt-4 border-t border-gray-200 flex justify-between items-center">
                    <span class="status-indicator inline-block text-xs font-semibold px-2.5 py-0.5 rounded-full capitalize"></span>
                    <div class="flex gap-2">
                        <button class="status-button status-pass text-sm font-medium py-1.5 px-3 rounded-full border border-green-500 text-green-700 hover:bg-green-100" data-action="pass">Pass</button>
                        <button class="status-button status-fail text-sm font-medium py-1.5 px-3 rounded-full border border-red-500 text-red-700 hover:bg-red-100" data-action="fail">Fail</button>
                    </div>
                </div>
            `;

            updateCardDisplayStatus(card, tc.status);

            const passButton = card.querySelector('.status-pass');
            const failButton = card.querySelector('.status-fail');
            const deleteButton = card.querySelector('.delete-test-case-btn');
            const editButton = card.querySelector('.edit-test-case-btn');

            passButton.addEventListener('click', async () => {
                const currentStatus = card.dataset.status;
                const newStatus = (currentStatus === 'pass') ? 'pending' : 'pass';
                updateCardDisplayStatus(card, newStatus);
                const tcIndex = testCases.findIndex(t => t.id === tc.id);
                if (tcIndex !== -1) {
                    testCases[tcIndex].status = newStatus;
                    await saveTestCaseToFirestore(testCases[tcIndex]);
                }
            });
            failButton.addEventListener('click', async () => {
                const currentStatus = card.dataset.status;
                const newStatus = (currentStatus === 'fail') ? 'pending' : 'fail';
                updateCardDisplayStatus(card, newStatus);
                const tcIndex = testCases.findIndex(t => t.id === tc.id);
                if (tcIndex !== -1) {
                    testCases[tcIndex].status = newStatus;
                    await saveTestCaseToFirestore(testCases[tcIndex]);
                }
            });

            deleteButton.addEventListener('click', async () => {
                if (confirm(`Are you sure you want to delete test case ${tc.id} - "${tc.description}"?`)) {
                    await deleteTestCaseFromFirestore(tc.id);
                }
            });

            editButton.addEventListener('click', () => {
                openEditModal(tc.id);
            });

            return card;
        }

        function displayTestCases(filter = 'all') {
            grid.innerHTML = '';
            currentFilter = filter;
            
            const filteredCases = testCases.filter(tc => filter === 'all' || tc.category === filter);
            
            filteredCases.forEach(tc => {
                grid.appendChild(createTestCaseCard(tc));
            });

            updateCaseCounter();
        }
        
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                displayTestCases(button.dataset.filter);
            });
        });

        // Add New Test Case Modal Logic
        const addTestCaseBtn = document.getElementById('add-test-case-btn');
        const addTestCaseModal = document.getElementById('add-test-case-modal');
        const addTestCaseForm = document.getElementById('add-test-case-form');
        const cancelAddTestCaseBtn = document.getElementById('cancel-add-test-case');

        addTestCaseBtn.addEventListener('click', () => {
            addTestCaseModal.classList.remove('hidden');
        });

        cancelAddTestCaseBtn.addEventListener('click', () => {
            addTestCaseModal.classList.add('hidden');
            addTestCaseForm.reset();
        });

        addTestCaseForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const newId = document.getElementById('new-test-id').value.trim();
            const newCategory = document.getElementById('new-test-category').value;
            const newDescription = document.getElementById('new-test-description').value.trim();
            const newPreconditions = document.getElementById('new-test-preconditions').value.split('\n').map(line => line.trim()).filter(line => line !== '');
            const newTestSteps = document.getElementById('new-test-steps').value.split('\n').map(line => line.trim()).filter(line => line !== '');
            const newExpectedResult = document.getElementById('new-test-expected-result').value.trim();

            if (!newId || !newDescription || !newExpectedResult) {
                alert('Please fill in all required fields: Test Case ID, Description, and Expected Result.');
                return;
            }

            if (testCases.some(tc => tc.id === newId)) {
                alert(`Test Case ID "${newId}" already exists. Please use a unique ID.`);
                return;
            }

            const newTestCase = {
                id: newId,
                category: newCategory,
                description: newDescription,
                preConditions: newPreconditions,
                testSteps: newTestSteps,
                expectedResult: newExpectedResult,
                status: 'pending' // New test cases start as pending
            };

            await saveTestCaseToFirestore(newTestCase); // Save to Firestore
            
            addTestCaseModal.classList.add('hidden');
            addTestCaseForm.reset();
        });

        // Edit Test Case Modal Logic
        const editTestCaseModal = document.getElementById('edit-test-case-modal');
        const editTestCaseForm = document.getElementById('edit-test-case-form');
        const cancelEditTestCaseBtn = document.getElementById('cancel-edit-test-case');
        const editOriginalIdInput = document.getElementById('edit-original-id');

        function openEditModal(testCaseId) {
            const tcToEdit = testCases.find(tc => tc.id === testCaseId);
            if (!tcToEdit) {
                console.error("Test case not found for editing:", testCaseId);
                return;
            }

            // Populate the edit form fields
            document.getElementById('edit-original-id').value = tcToEdit.id; // Store original ID for lookup
            document.getElementById('edit-test-id').value = tcToEdit.id;
            document.getElementById('edit-test-category').value = tcToEdit.category;
            document.getElementById('edit-test-description').value = tcToEdit.description;
            // Ensure preConditions and testSteps are handled correctly if they are not arrays or are null/undefined
            document.getElementById('edit-test-preconditions').value = Array.isArray(tcToEdit.preConditions) ? tcToEdit.preConditions.join('\n') : tcToEdit.preConditions || '';
            document.getElementById('edit-test-steps').value = Array.isArray(tcToEdit.testSteps) ? tcToEdit.testSteps.join('\n') : tcToEdit.testSteps || '';
            document.getElementById('edit-test-expected-result').value = tcToEdit.expectedResult;

            editTestCaseModal.classList.remove('hidden'); // Show the modal
        }

        cancelEditTestCaseBtn.addEventListener('click', () => {
            editTestCaseModal.classList.add('hidden');
            editTestCaseForm.reset();
        });

        editTestCaseForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const originalId = document.getElementById('edit-original-id').value;
            const updatedId = document.getElementById('edit-test-id').value.trim();
            const updatedCategory = document.getElementById('edit-test-category').value;
            const updatedDescription = document.getElementById('edit-test-description').value.trim();
            const updatedPreconditions = document.getElementById('edit-test-preconditions').value.split('\n').map(line => line.trim()).filter(line => line !== '');
            const updatedTestSteps = document.getElementById('edit-test-steps').value.split('\n').map(line => line.trim()).filter(line => line !== '');
            const updatedExpectedResult = document.getElementById('edit-test-expected-result').value.trim();

            if (!updatedId || !updatedDescription || !updatedExpectedResult) {
                alert('Please fill in all required fields: Test Case ID, Description, and Expected Result.');
                return;
            }

            // Check for duplicate ID if ID was changed
            if (updatedId !== originalId && testCases.some(tc => tc.id === updatedId)) {
                alert(`Test Case ID "${updatedId}" already exists. Please use a unique ID.`);
                return;
            }

            const testCaseIndex = testCases.findIndex(tc => tc.id === originalId);
            if (testCaseIndex !== -1) {
                const updatedTestCase = {
                    ...testCases[testCaseIndex], // Keep existing properties like status
                    id: updatedId,
                    category: updatedCategory,
                    description: updatedDescription,
                    preConditions: updatedPreconditions,
                    testSteps: updatedTestSteps,
                    expectedResult: updatedExpectedResult
                };
                // If ID changed, delete old doc and create new one
                if (originalId !== updatedId) {
                    await deleteTestCaseFromFirestore(originalId);
                }
                await saveTestCaseToFirestore(updatedTestCase); // Save the updated/new doc
                
                editTestCaseModal.classList.add('hidden');
                editTestCaseForm.reset();
            } else {
                console.error("Original test case not found for update:", originalId);
                alert("Error: Test case not found for update.");
            }
        });


        // Function to generate and download CSV
        function generateExcelFile() {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const projectName = "CRBT Service Test Suite";
            const moduleName = "SMS Notification & Subscription Logic";
            const version = "1.0";

            let csvContent = "";

            // Add Header/Metadata
            csvContent += `"Project:","${projectName}"\n`;
            csvContent += `"Module:","${moduleName}"\n`;
            csvContent += `"Date:","${currentDate}"\n`;
            csvContent += `"Version:","${version}"\n`;
            csvContent += "\n"; // Empty line for separation

            // Add Column Headers
            csvContent += "No.,Test Case ID,Description,Pre-conditions,Test Steps,Expected Result,Status,Testing MSISDN,Testing Result,Testing Time,Remarks\n";

            testCases.forEach((tc, index) => {
                // Escape commas and newlines within fields by enclosing them in double quotes
                const escapeCsvField = (field) => {
                    if (typeof field === 'string') {
                        // Replace double quotes with two double quotes, then wrap in double quotes
                        return `"${field.replace(/"/g, '""').replace(/\n/g, '\r\n')}"`; // Handle newlines
                    } else if (Array.isArray(field)) {
                        // For arrays, join with a semicolon and escape the whole string
                        return `"${field.map(item => item.replace(/"/g, '""').replace(/\n/g, '\r\n')).join('; ')}"`;
                    }
                    return field; // For numbers, booleans etc.
                };

                const description = escapeCsvField(tc.description);
                const preConditions = escapeCsvField(tc.preConditions);
                const testSteps = escapeCsvField(tc.testSteps);
                const expectedResult = escapeCsvField(tc.expectedResult);
                const status = escapeCsvField(tc.status);

                // Add empty columns for manual input in Excel
                const emptyColumns = ',"","","",""'; // Testing MSISDN, Testing Result, Testing Time, Remarks

                csvContent += `${index + 1},${tc.id},${description},${preConditions},${testSteps},${expectedResult},${status}${emptyColumns}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `CRBT_Test_Report_${currentDate.replace(/\//g, '-')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Your browser does not support downloading files directly. Please copy the content and paste it into a spreadsheet program.');
            }
        }

        document.getElementById('generate-excel-btn').addEventListener('click', generateExcelFile);

        // Main loading logic: Listen for Firebase ready event
        window.addEventListener('firebaseReady', () => {
            const appId = window.getAppId();
            // Use a distinct collection for CRBT test cases
            const testCasesCollectionRef = collection(window.firestoreDb, `artifacts/${appId}/public/data/crbt_test_cases`);
            console.log(`Attempting to listen to Firestore collection: artifacts/${appId}/public/data/crbt_test_cases`); // Added for debugging

            // Set up real-time listener for test cases
            onSnapshot(testCasesCollectionRef, (snapshot) => {
                loadingMessage.classList.add('hidden'); // Hide loading message once data starts coming
                let updatedTestCases = [];
                snapshot.forEach(doc => {
                    updatedTestCases.push(doc.data());
                });

                // If Firestore is empty, populate with initial data
                // Only populate if the collection is truly empty AND there are default test cases
                if (snapshot.empty && testCases.length > 0) {
                    console.log("Firestore collection is empty, populating with initial data.");
                    // Use a copy of initial testCases to avoid modifying the original during iteration
                    const initialDataToSave = JSON.parse(JSON.stringify(testCases)); // Deep copy
                    initialDataToSave.forEach(async (tc) => {
                        await saveTestCaseToFirestore(tc);
                    });
                    // The onSnapshot will trigger again with the new data
                } else {
                    // Sort the updatedTestCases array by ID to maintain consistent order
                    updatedTestCases.sort((a, b) => a.id.localeCompare(b.id));
                    testCases = updatedTestCases; // Update local array with data from Firestore
                    displayTestCases(currentFilter); // Re-render the UI
                }
            }, (error) => {
                console.error("Error listening to Firestore updates:", error);
                loadingMessage.textContent = `Error loading data. Please check your Firebase Firestore security rules for "artifacts/${window.getAppId()}/public/data/crbt_test_cases". Ensure 'allow read, write: if request.auth != null;' is set.`;
                loadingMessage.classList.add('text-red-600');
            });
        });

        // Initial display of loading message
        window.onload = () => {
            loadingMessage.classList.remove('hidden');
        };
    </script>

</body>
</html>
