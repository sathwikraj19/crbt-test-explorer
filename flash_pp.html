<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flash Service Project Plan – Interactive Gantt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --surface: #ffffff;
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --chip-bg: #eef2ff;
      --radius-lg: 16px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.13);
      --grid-line: #e5e7eb;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #4f46e5, #0f172a 55%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .page {
      max-width: 1220px;
      width: 100%;
      background: radial-gradient(circle at top left, #eef2ff, #ffffff 55%);
      border-radius: 22px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      border-bottom: 1px solid rgba(148,163,184,0.35);
      background: linear-gradient(90deg, #4f46e5, #0ea5e9);
      color: #e5e7eb;
      font-size: 13px;
    }
    .topbar small { font-size: 11px; opacity: 0.9; }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(270px, 0.9fr);
      gap: 0;
      padding: 12px 16px 16px;
    }
    .left, .right { padding: 10px; }

    @media (max-width: 900px) {
      .main-layout { grid-template-columns: minmax(0, 1fr); }
      .right { padding-top: 0; }
    }

    [contenteditable="true"] {
      border-bottom: 1px dashed rgba(148,163,184,0.6);
      padding-bottom: 2px;
      cursor: text;
    }

    .header-block { margin-bottom: 10px; }

    .title-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }
    .title-row h1 { font-size: 19px; font-weight: 700; }
    .title-row span { font-size: 11px; color: var(--text-muted); }

    .filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 11px;
      align-items: center;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      background: var(--chip-bg);
      border: 1px solid rgba(99,102,241,0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease, transform 0.12s ease;
    }
    .chip-dot { width: 7px; height: 7px; border-radius: 999px; }
    .chip:hover { transform: translateY(-1px); background: #e0e7ff; }
    .chip--active { background: #4f46e5; color: #e5e7eb; border-color: transparent; }
    .chip--active .chip-dot { background: #e5e7eb !important; }

    .gantt-shell {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--surface);
      display: grid;
      grid-template-columns: 200px minmax(0, 1fr);
      overflow: hidden;
    }
    @media (max-width: 640px) {
      .gantt-shell { grid-template-columns: minmax(0, 1fr); }
      .gantt-phases { border-right: none; border-bottom: 1px solid var(--border); }
    }

    .gantt-phases {
      background: #f8fafc;
      border-right: 1px solid var(--border);
    }

    .gantt-header, .timeline-header {
      padding: 8px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      background: rgba(248,250,252,0.95);
      border-bottom: 1px solid var(--border);
    }

    .phases-list { list-style: none; }

    .phase-row {
      padding: 10px 10px;
      border-bottom: 1px dashed rgba(148,163,184,0.35);
      position: relative;
      overflow: hidden;
    }

    .phase-title { font-size: 13px; font-weight: 600; }
    .phase-sub  { font-size: 11px; color: var(--text-muted); margin-top: 3px; line-height: 1.3; }

    .timeline-wrapper {
      position: relative;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      background: #ffffff;
    }
    .timeline-inner { min-width: 700px; position: relative; }

    .timeline-header-row {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(40px, 1fr);
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      padding: 8px 0;
    }
    .timeline-day { border-left: 1px solid #f1f5f9; }

    .timeline-grid { position: relative; }
    .timeline-grid-row {
      border-top: 1px solid var(--grid-line);
      position: relative;
    }

    .task-bar {
      position: absolute;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0 4px;
      font-size: 11px;
      color: #f9fafb;
      cursor: grab;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 10px 20px rgba(15,23,42,0.25);
      user-select: none;
      z-index: 10;
    }
    .task-bar:active { cursor: grabbing; }
    .task-bar.drag-highlight {
      box-shadow: 0 16px 32px rgba(56,189,248,0.55);
    }

    .task-pill {
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.2);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      flex-shrink: 0;
    }
    .task-avatar {
      width: 18px; height: 18px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-main);
      flex-shrink: 0;
    }
    .task-title { font-weight: 600; }

    .resize-handle {
      width: 6px;
      height: 70%;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 0 0 1px rgba(15,23,42,0.15);
      cursor: ew-resize;
      flex-shrink: 0;
    }

    .tooltip {
      position: fixed;
      pointer-events: none;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: 0 18px 30px rgba(15,23,42,0.85);
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.12s ease, transform 0.12s ease;
      z-index: 50;
      max-width: 260px;
      line-height: 1.4;
    }
    .tooltip.visible { opacity: 1; transform: translateY(0); }
    .tooltip-title { font-weight: 600; margin-bottom: 4px; color: #f9fafb; }
    .tooltip-line { display: flex; justify-content: space-between; gap: 12px; }

    /* vertical red line */
    .today-line {
      position: absolute;
      top: 40px;
      bottom: 0;
      width: 2px;
      background: #ef4444;
      box-shadow: 0 0 0 1px rgba(248,113,113,0.6);
      z-index: 5;
      pointer-events: none;
    }
    .today-line::before {
      content: "";
      position: absolute;
      top: -6px;
      left: -3px;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ef4444;
    }

    .panel {
      background: rgba(255,255,255,0.94);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 10px 11px;
      margin-bottom: 10px;
    }
    .panel-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .avatars { display: flex; flex-wrap: wrap; gap: 6px; }
    .avatar {
      width: 28px; height: 28px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center; justify-content: center;
      color: #f9fafb;
      font-weight: 600; font-size: 11px;
      background: linear-gradient(135deg, #4f46e5, #ec4899);
      box-shadow: 0 6px 15px rgba(148,163,184,0.7);
    }

    .task-details {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .task-details strong { color: var(--text-main); }

    .pill-row {
      display: flex; flex-wrap: wrap;
      gap: 6px; margin-top: 6px;
    }
    .info-pill {
      font-size: 10px;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.9);
      background: #f9fafb;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 8px;
      margin-top: 6px;
    }
    @media (max-width: 480px) { .form-grid { grid-template-columns: 1fr; } }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .field label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }
    .field input,
    .field select,
    .field textarea {
      font-size: 11px;
      padding: 5px 7px;
      border-radius: 6px;
      border: 1px solid var(--border);
      outline: none;
      font-family: inherit;
    }
    .field textarea { resize: vertical; min-height: 48px; }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .btn {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary { background: #4f46e5; color: #f9fafb; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <div contenteditable="true">Flash Service Project Plan</div>
      <small>Year: 2025 &nbsp;•&nbsp; Month: November</small>
    </div>

    <div class="main-layout">
      <!-- LEFT: GANTT -->
      <section class="left">
        <div class="header-block">
          <div class="title-row">
            <h1 contenteditable="true">Implementation Gantt – Flash Service</h1>
            <span>Drag bars left / right to change dates. Drag edges to change duration.</span>
          </div>

          <div class="filters">
            <span>Status:</span>
            <button class="chip chip--active" data-filter="all">All</button>
            <button class="chip" data-filter="done">
              <span class="chip-dot" style="background:#22c55e;"></span>Done
            </button>
            <button class="chip" data-filter="on-going">
              <span class="chip-dot" style="background:#0ea5e9;"></span>On-Going
            </button>
            <button class="chip" data-filter="upcoming">
              <span class="chip-dot" style="background:#facc15;"></span>Upcoming
            </button>
          </div>
        </div>

        <div class="gantt-shell">
          <aside class="gantt-phases">
            <div class="gantt-header">Phases</div>
            <ul class="phases-list" id="phaseList"></ul>
          </aside>

          <section class="timeline-wrapper">
            <div class="timeline-inner">
              <div class="timeline-header">
                <div class="timeline-header-row" id="timelineHeaderRow"></div>
              </div>

              <div id="todayLine" class="today-line"></div>

              <div class="timeline-grid" id="timelineGrid"></div>
            </div>
          </section>
        </div>
      </section>

      <!-- RIGHT: DETAILS + EDITOR -->
      <aside class="right">
        <div class="panel">
          <div class="panel-title">
            Project Team
            <span style="font-size:10px;">Edit initials by typing</span>
          </div>
          <div class="avatars">
            <div class="avatar" contenteditable="true">SR</div>
            <div class="avatar" contenteditable="true">RK</div>
            <div class="avatar" contenteditable="true">AB</div>
            <div class="avatar" contenteditable="true">PM</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">
            Selected Task
            <span id="selectedStatusLabel" style="font-size:10px;"></span>
          </div>
          <div class="task-details" id="taskDetails">
            <p>Select or drag a task to see details here.</p>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">
            Task Editor
            <span style="font-size:10px;">You can also change dates manually</span>
          </div>

          <div class="field">
            <label for="taskSelect">Choose Task</label>
            <select id="taskSelect"></select>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="taskTitle">Title</label>
              <input id="taskTitle" type="text" />
            </div>
            <div class="field">
              <label for="taskOwner">Owner (Initials)</label>
              <input id="taskOwner" type="text" />
            </div>
            <div class="field">
              <label for="taskPhase">Phase</label>
              <select id="taskPhase"></select>
            </div>
            <div class="field">
              <label for="taskStatus">Status</label>
              <select id="taskStatus">
                <option value="done">Done</option>
                <option value="on-going">On-Going</option>
                <option value="upcoming">Upcoming</option>
              </select>
            </div>
            <div class="field">
              <label for="taskStart">Start Date</label>
              <input id="taskStart" type="date" />
            </div>
            <div class="field">
              <label for="taskEnd">End Date</label>
              <input id="taskEnd" type="date" />
            </div>
          </div>

          <div class="field" style="margin-top:6px;">
            <label for="taskNotes">Notes / Description</label>
            <textarea id="taskNotes"></textarea>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" type="button" id="saveTaskBtn">Save / Update Task</button>
            <button class="btn btn-secondary" type="button" id="addTaskBtn">Add as New Task</button>
            <button class="btn btn-secondary" type="button" id="downloadBtn">Download JSON</button>
          </div>
        </div>
      </aside>
    </div>

    <div id="tooltip" class="tooltip"></div>
  </div>

  <script>
    function initGantt() {
      const YEAR = 2025;
      const MONTH_INDEX = 10; // November
      const TOTAL_DAYS = 30;

      const phases = [
        { id: "kickoff",    title: "Requirement & Kickoff",          sub: "Scope freeze, timelines, use cases, dependencies",      color: "#6366f1" },
        { id: "config",     title: "Flash Config & Routing",         sub: "Environment readiness, service config, routing tables",  color: "#0ea5e9" },
        { id: "integration",title: "Integrations (SDP / IVR / Charging)", sub: "SDP, IVR, SMSC, charging & reporting integrations", color: "#22c55e" },
        { id: "sit",        title: "System Integration Testing (SIT)",sub: "Core flows, negative scenarios, capacity & failover",   color: "#6366f1" },
        { id: "uat",        title: "User Acceptance Testing (UAT)",  sub: "Client test execution, defect fixing & sign-off",        color: "#0ea5e9" },
        { id: "golive",     title: "Go-Live & Hypercare",            sub: "Cutover, monitoring, handover to operations",            color: "#111827" }
      ];

      let tasks = [
        { id: 1,  phaseId: "kickoff",    title: "Project Kick-off & Scope Freeze",  owner: "SR", status: "done",     startDay: 1,  endDay: 3,
          notes: "Kick-off meeting with client; agree on scope and milestones." },
        { id: 2,  phaseId: "kickoff",    title: "Requirement Walkthrough & KT",     owner: "PM", status: "on-going", startDay: 2,  endDay: 6,
          notes: "Detailed walkthrough of flows, charging rules, reporting and alarms." },
        { id: 3,  phaseId: "config",     title: "Environment Readiness (UAT Flash)",owner: "RK", status: "on-going", startDay: 4,  endDay: 8,
          notes: "Validate UAT servers, connectivity, certificates and base installation." },
        { id: 4,  phaseId: "config",     title: "Flash Service Config & Routing",   owner: "SR", status: "upcoming", startDay: 7,  endDay: 14,
          notes: "Configure Flash apps, IN parameters, routing logic and failover." },
        { id: 5,  phaseId: "integration",title: "SDP / IVR Integration",            owner: "AB", status: "upcoming", startDay: 11, endDay: 18,
          notes: "End-to-end signalling integration with SDP/IVR and callbacks." },
        { id: 6,  phaseId: "integration",title: "Charging & Billing Validation",    owner: "RK", status: "upcoming", startDay: 15, endDay: 20,
          notes: "Validate rate plans, free/chargeable flows and CDR generation." },
        { id: 7,  phaseId: "sit",        title: "SIT – Core Call Flows",            owner: "SR", status: "upcoming", startDay: 19, endDay: 23,
          notes: "Run core inbound/outbound scenarios and happy paths." },
        { id: 8,  phaseId: "sit",        title: "SIT – Negative & Load",            owner: "AB", status: "upcoming", startDay: 22, endDay: 28,
          notes: "Negative, timeout, retry and basic load tests." },
        { id: 9,  phaseId: "uat",        title: "Client UAT Cycle",                 owner: "PM", status: "upcoming", startDay: 24, endDay: 30,
          notes: "Client executes UAT, track defects and obtain sign-off." },
        { id:10,  phaseId: "golive",     title: "Production Cutover & Sanity",      owner: "RK", status: "upcoming", startDay: 26, endDay: 28,
          notes: "Cutover to PROD and sanity checks." },
        { id:11,  phaseId: "golive",     title: "Hypercare & Handover",             owner: "SR", status: "upcoming", startDay: 29, endDay: 30,
          notes: "Monitor KPIs and handover to ops." }
      ];

      function dayToDateStr(day) {
        const d = new Date(YEAR, MONTH_INDEX, day);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return yyyy + "-" + mm + "-" + dd;
      }

      function dateStrToDay(str) {
        if (!str) return null;
        const d = new Date(str);
        if (isNaN(d)) return null;
        if (d.getFullYear() !== YEAR || d.getMonth() !== MONTH_INDEX) return null;
        return d.getDate();
      }

      const phaseListEl = document.getElementById("phaseList");
      const headerRowEl = document.getElementById("timelineHeaderRow");
      const gridEl      = document.getElementById("timelineGrid");
      const tooltipEl   = document.getElementById("tooltip");
      const detailsEl   = document.getElementById("taskDetails");
      const selectedStatusLabel = document.getElementById("selectedStatusLabel");
      const todayLineEl = document.getElementById("todayLine");

      const taskSelect  = document.getElementById("taskSelect");
      const phaseSelect = document.getElementById("taskPhase");
      const titleInput  = document.getElementById("taskTitle");
      const ownerInput  = document.getElementById("taskOwner");
      const statusSelect= document.getElementById("taskStatus");
      const startInput  = document.getElementById("taskStart");
      const endInput    = document.getElementById("taskEnd");
      const notesInput  = document.getElementById("taskNotes");
      const downloadBtn = document.getElementById("downloadBtn");

      function buildPhases() {
        phases.forEach(function(phase) {
          const li = document.createElement("li");
          li.className = "phase-row";
          li.dataset.phaseId = phase.id;
          li.innerHTML =
            '<div class="phase-title" contenteditable="true">' + phase.title + '</div>' +
            '<div class="phase-sub" contenteditable="true">' + phase.sub + '</div>';
          phaseListEl.appendChild(li);
        });
      }

      function buildHeaderDays() {
        for (let day = 1; day <= TOTAL_DAYS; day++) {
          const d = new Date(YEAR, MONTH_INDEX, day);
          const short = d.toLocaleDateString("en-GB", { weekday: "short" });
          const cell = document.createElement("div");
          cell.className = "timeline-day";
          cell.innerHTML = "<div>" + day + "</div><div style='font-size:9px;'>" + short + "</div>";
          headerRowEl.appendChild(cell);
        }
      }

      function buildGridRows() {
        phases.forEach(function(phase) {
          const row = document.createElement("div");
          row.className = "timeline-grid-row";
          row.dataset.phaseId = phase.id;
          gridEl.appendChild(row);
        });
      }

      function positionTodayLine() {
        const headerEl = document.querySelector(".timeline-header");
        if (headerEl) {
          todayLineEl.style.top = headerEl.offsetHeight + "px";
        }

        const today = new Date();
        let day = null;
        if (today.getFullYear() === YEAR && today.getMonth() === MONTH_INDEX) {
          day = today.getDate();
        }
        if (!day || day < 1 || day > TOTAL_DAYS) {
          day = Math.ceil(TOTAL_DAYS / 2); // centre if not this month
        }

        const leftPercent = (day - 0.5) / TOTAL_DAYS * 100;
        todayLineEl.style.left = leftPercent + "%";
      }

      function populatePhaseSelect() {
        phaseSelect.innerHTML = "";
        phases.forEach(function(p) {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.title;
          phaseSelect.appendChild(opt);
        });
      }

      function populateTaskSelect() {
        taskSelect.innerHTML = "";
        tasks.forEach(function(t) {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.id + ". " + t.title;
          taskSelect.appendChild(opt);
        });
      }

      function positionBar(bar, startDay, endDay) {
        const leftPercent  = (startDay - 1) / TOTAL_DAYS * 100;
        const widthPercent = (endDay - startDay + 1) / TOTAL_DAYS * 100;
        bar.style.left  = leftPercent + "%";
        bar.style.width = widthPercent + "%";
      }

      function clearTaskBars() {
        document.querySelectorAll(".task-bar").forEach(function(el) { el.remove(); });
      }

      function showTaskDetails(taskId) {
        const task = tasks.find(function(t) { return t.id === taskId; });
        if (!task) return;
        const phase = phases.find(function(p) { return p.id === task.phaseId; });
        const phaseTitle = phase ? phase.title : "";
        const statusText =
          task.status === "done" ? "Done" :
          task.status === "on-going" ? "On-Going" : "Upcoming";

        selectedStatusLabel.textContent = statusText;
        detailsEl.innerHTML =
          "<p><strong>" + task.title + "</strong></p>" +
          "<p style='margin-top:4px;'>" + (task.notes || "") + "</p>" +
          "<div class='pill-row'>" +
            "<span class='info-pill'>Phase: " + phaseTitle + "</span>" +
            "<span class='info-pill'>Owner: " + task.owner + "</span>" +
            "<span class='info-pill'>Start: " + dayToDateStr(task.startDay) + "</span>" +
            "<span class='info-pill'>End: " + dayToDateStr(task.endDay) + "</span>" +
            "<span class='info-pill'>Status: " + statusText + "</span>" +
          "</div>";
      }

      function moveTooltip(e) {
        const padding = 12;
        tooltipEl.style.left = e.clientX + padding + "px";
        tooltipEl.style.top  = e.clientY + padding + "px";
      }

      let dragState = null;

      function attachTaskEvents() {
        document.querySelectorAll(".task-bar").forEach(function(bar) {
          const taskId = Number(bar.dataset.taskId);
          const task = tasks.find(function(t) { return t.id === taskId; });
          if (!task) return;
          const phase = phases.find(function(p) { return p.id === task.phaseId; });
          const phaseTitle = phase ? phase.title : "";
          const statusText =
            task.status === "done" ? "Done" :
            task.status === "on-going" ? "On-Going" : "Upcoming";

          bar.addEventListener("mouseenter", function(e) {
            tooltipEl.innerHTML =
              "<div class='tooltip-title'>" + task.title + "</div>" +
              "<div class='tooltip-line'><span><strong>Phase:</strong> " + phaseTitle +
              "</span><span><strong>Owner:</strong> " + task.owner + "</span></div>" +
              "<div class='tooltip-line' style='margin-top:4px;'><span><strong>Start:</strong> " +
              dayToDateStr(task.startDay) + "</span><span><strong>End:</strong> " +
              dayToDateStr(task.endDay) + "</span></div>" +
              "<div style='margin-top:4px;'><strong>Status:</strong> " + statusText + "</div>";
            tooltipEl.classList.add("visible");
            moveTooltip(e);
          });
          bar.addEventListener("mousemove", moveTooltip);
          bar.addEventListener("mouseleave", function() {
            tooltipEl.classList.remove("visible");
          });

          bar.addEventListener("click", function() {
            document.querySelectorAll(".task-bar").forEach(function(b) {
              b.style.outline = "none";
            });
            bar.style.outline = "2px solid rgba(56,189,248,0.85)";
            fillEditorWithTask(taskId);
            showTaskDetails(taskId);
          });

          // drag start
          bar.addEventListener("mousedown", function(e) {
            e.preventDefault();

            tooltipEl.classList.remove("visible");

            const row = bar.parentElement;
            const rect = row.getBoundingClientRect();
            const dayWidth = rect.width / TOTAL_DAYS;

            let mode = "move";
            if (e.target.classList.contains("resize-left")) mode = "left";
            else if (e.target.classList.contains("resize-right")) mode = "right";

            dragState = {
              mode: mode,
              taskId: taskId,
              startDay: task.startDay,
              endDay: task.endDay,
              startX: e.clientX,
              dayWidth: dayWidth,
              bar: bar
            };

            bar.classList.add("drag-highlight");
            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
          });
        });
      }

      function onMouseMove(e) {
        if (!dragState) return;
        const dx = e.clientX - dragState.startX;
        const deltaDays = Math.round(dx / dragState.dayWidth);

        let newStart = dragState.startDay;
        let newEnd   = dragState.endDay;

        if (dragState.mode === "move") {
          const dur = dragState.endDay - dragState.startDay;
          newStart = dragState.startDay + deltaDays;
          newEnd   = newStart + dur;
          if (newStart < 1) { newStart = 1; newEnd = newStart + dur; }
          if (newEnd > TOTAL_DAYS) { newEnd = TOTAL_DAYS; newStart = newEnd - dur; }
        } else if (dragState.mode === "left") {
          newStart = dragState.startDay + deltaDays;
          if (newStart < 1) newStart = 1;
          if (newStart >= newEnd) newStart = newEnd - 1;
        } else if (dragState.mode === "right") {
          newEnd = dragState.endDay + deltaDays;
          if (newEnd > TOTAL_DAYS) newEnd = TOTAL_DAYS;
          if (newEnd <= newStart) newEnd = newStart + 1;
        }

        positionBar(dragState.bar, newStart, newEnd);
      }

      function onMouseUp(e) {
        if (!dragState) return;

        const dx = e.clientX - dragState.startX;
        const deltaDays = Math.round(dx / dragState.dayWidth);

        let newStart = dragState.startDay;
        let newEnd   = dragState.endDay;

        if (dragState.mode === "move") {
          const dur = dragState.endDay - dragState.startDay;
          newStart = dragState.startDay + deltaDays;
          newEnd   = newStart + dur;
          if (newStart < 1) { newStart = 1; newEnd = newStart + dur; }
          if (newEnd > TOTAL_DAYS) { newEnd = TOTAL_DAYS; newStart = newEnd - dur; }
        } else if (dragState.mode === "left") {
          newStart = dragState.startDay + deltaDays;
          if (newStart < 1) newStart = 1;
          if (newStart >= newEnd) newStart = newEnd - 1;
        } else if (dragState.mode === "right") {
          newEnd = dragState.endDay + deltaDays;
          if (newEnd > TOTAL_DAYS) newEnd = TOTAL_DAYS;
          if (newEnd <= newStart) newEnd = newStart + 1;
        }

        const task = tasks.find(function(t) { return t.id === dragState.taskId; });
        if (task) {
          task.startDay = newStart;
          task.endDay   = newEnd;
        }

        dragState.bar.classList.remove("drag-highlight");
        dragState = null;
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);

        populateTaskSelect();
        renderTasks(document.querySelector(".chip--active").dataset.filter);
        fillEditorWithTask(task.id);
        showTaskDetails(task.id);
      }

      function renderTasks(filterStatus) {
        clearTaskBars();

        // reset heights to auto
        document.querySelectorAll(".timeline-grid-row").forEach(function(row) {
          row.style.height = "auto";
        });
        document.querySelectorAll(".phase-row").forEach(function(row) {
          row.style.height = "auto";
        });

        const tasksPerPhase = {};
        tasks.forEach(function(task) {
          if (filterStatus !== "all" && task.status !== filterStatus) return;
          if (!tasksPerPhase[task.phaseId]) tasksPerPhase[task.phaseId] = [];
          tasksPerPhase[task.phaseId].push(task);
        });

        const baseTop = 14;   // more breathing room
        const laneGap = 30;
        const minHeight = 70;

        Object.keys(tasksPerPhase).forEach(function(phaseId) {
          const row = document.querySelector(
            '.timeline-grid-row[data-phase-id="' + phaseId + '"]'
          );
          const phaseRow = document.querySelector(
            '.phase-row[data-phase-id="' + phaseId + '"]'
          );
          if (!row) return;
          const list = tasksPerPhase[phaseId];

          const rowHeight = Math.max(minHeight, baseTop * 2 + laneGap * list.length);
          row.style.height = rowHeight + "px";
          if (phaseRow) phaseRow.style.height = rowHeight + "px";

          list.forEach(function(task, index) {
            const bar = document.createElement("div");
            bar.className = "task-bar";
            bar.dataset.taskId = task.id;
            bar.dataset.status = task.status;

            const phase = phases.find(function(p) { return p.id === task.phaseId; });
            bar.style.background = phase ? phase.color : "#6366f1";

            const statusLabel =
              task.status === "done" ? "Done" :
              task.status === "on-going" ? "On-Going" : "Upcoming";

            bar.innerHTML =
              '<span class="resize-handle resize-left"></span>' +
              '<span class="task-pill">' + statusLabel + '</span>' +
              '<span class="task-title">' + task.title + '</span>' +
              '<span class="task-avatar">' + task.owner + '</span>' +
              '<span class="resize-handle resize-right"></span>';

            row.appendChild(bar);
            positionBar(bar, task.startDay, task.endDay);
            bar.style.top = (baseTop + index * laneGap) + "px";
          });
        });

        attachTaskEvents();
      }

      function fillEditorWithTask(taskId) {
        const task = tasks.find(function(t) { return t.id === Number(taskId); });
        if (!task) return;
        taskSelect.value    = task.id;
        titleInput.value    = task.title;
        ownerInput.value    = task.owner;
        phaseSelect.value   = task.phaseId;
        statusSelect.value  = task.status;
        startInput.value    = dayToDateStr(task.startDay);
        endInput.value      = dayToDateStr(task.endDay);
        notesInput.value    = task.notes || "";
      }

      document.querySelectorAll(".chip").forEach(function(chip) {
        chip.addEventListener("click", function() {
          const filter = chip.dataset.filter;
          document.querySelectorAll(".chip").forEach(function(c) {
            c.classList.remove("chip--active");
          });
          chip.classList.add("chip--active");
          renderTasks(filter);
        });
      });

      taskSelect.addEventListener("change", function() {
        fillEditorWithTask(taskSelect.value);
        showTaskDetails(Number(taskSelect.value));
      });

      document.getElementById("saveTaskBtn").addEventListener("click", function() {
        const id = Number(taskSelect.value);
        const task = tasks.find(function(t) { return t.id === id; });
        if (!task) return;

        task.title   = titleInput.value.trim() || "Untitled Task";
        task.owner   = ownerInput.value.trim() || "--";
        task.phaseId = phaseSelect.value;
        task.status  = statusSelect.value;

        const sd = dateStrToDay(startInput.value);
        const ed = dateStrToDay(endInput.value);
        if (sd && ed && ed > sd) {
          task.startDay = sd;
          task.endDay   = ed;
        }

        task.notes = notesInput.value.trim();

        populateTaskSelect();
        renderTasks(document.querySelector(".chip--active").dataset.filter);
        fillEditorWithTask(id);
        showTaskDetails(id);
      });

      document.getElementById("addTaskBtn").addEventListener("click", function() {
        const newId = tasks.length ? Math.max.apply(null, tasks.map(function(t){return t.id;})) + 1 : 1;
        let sd = dateStrToDay(startInput.value) || 1;
        let ed = dateStrToDay(endInput.value) || (sd + 1);
        if (ed <= sd) ed = sd + 1;
        if (ed > TOTAL_DAYS) ed = TOTAL_DAYS;

        const newTask = {
          id: newId,
          title: titleInput.value.trim() || "New Task",
          owner: ownerInput.value.trim() || "--",
          phaseId: phaseSelect.value,
          status: statusSelect.value,
          startDay: sd,
          endDay: ed,
          notes: notesInput.value.trim()
        };
        tasks.push(newTask);
        populateTaskSelect();
        renderTasks(document.querySelector(".chip--active").dataset.filter);
        fillEditorWithTask(newId);
        showTaskDetails(newId);
      });

      // Download JSON plan
      downloadBtn.addEventListener("click", function() {
        const dataStr = JSON.stringify(tasks, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "flash_project_plan.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      buildPhases();
      buildHeaderDays();
      buildGridRows();
      populatePhaseSelect();
      populateTaskSelect();
      renderTasks("all");
      if (tasks.length > 0) {
        fillEditorWithTask(tasks[0].id);
        showTaskDetails(tasks[0].id);
      }
      positionTodayLine();
      window.addEventListener("resize", positionTodayLine);
    }

    window.addEventListener("load", initGantt);
  </script>
</body>
</html>
